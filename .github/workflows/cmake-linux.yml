name: Linux Build (GCC & Clang)

on:
  workflow_call:
    inputs:
      compiler:
        required: true
        type: string
      build_type:
        required: true
        type: string
      shared:
        required: true
        type: string

permissions:
  contents: read

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install compilers
        run: |
          sudo apt-get update
          if [[ "${{ inputs.compiler }}" == "clang" ]]; then
            sudo apt-get install -y clang
          else
            sudo apt-get install -y build-essential
          fi

      - name: Configure CMake (Linux)
        run: |
          cmake -B build
          -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          -DCMAKE_C_COMPILER=${{ inputs.compiler }}
          -DCMAKE_CXX_COMPILER=${{ inputs.compiler }}++
          -DCMAKE_BUILD_TYPE=${{ inputs.build_type }}
          -DPYRO_COMMON_BUILD_TESTS=ON
          -DPYRO_COMMON_SHARED_LIBRARY=${{ inputs.shared }}
          -S .

      - name: Build (Linux)
        run: cmake --build build --config ${{ inputs.build_type }} --parallel 4

      - name: Run tests
        working-directory: build
        run: ctest --build-config ${{ inputs.build_type }}
